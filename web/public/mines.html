<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DonutFlip Mines</title>
    <!-- <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"> -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js" crossorigin="anonymous" defer></script>
    <script src="js/balanceManager.js"></script>
    <style>
        /* Reset ve Temel Stiller */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #000000;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        /* Snow Animation Background */
        .background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: #000000;
            overflow: hidden;
        }

        .snow {
            position: absolute;
            top: -10px;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .snowflake {
            position: absolute;
            top: -10px;
            color: #ffffff;
            user-select: none;
            pointer-events: none;
            font-size: 12px;
            animation-name: fall;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }

        @keyframes fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0.3;
            }
        }


        /* Ana Container */
        .mines-container {
            display: flex;
            height: 100vh;
            padding: 20px;
            gap: 30px;
            align-items: flex-start;
            justify-content: center;
            overflow: hidden;
        }

        /* Sol Panel - Kontroller */
        .controls-panel {
            width: 280px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 20px;
            padding: 25px;
            height: fit-content;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        /* Header */
        .game-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .logo-icon::after {
            content: 'M';
            font-size: 20px;
            font-weight: bold;
        }

        .game-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }

        .balance-display {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .balance-label {
            font-size: 14px;
            color: #b4b4b4;
            margin-bottom: 5px;
        }

        .balance-amount {
            font-size: 24px;
            font-weight: 700;
            color: #26de81;
        }

        /* Tabs */
        .control-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #b4b4b4;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            border-color: rgba(79, 172, 254, 0.5);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-color: transparent;
            color: white;
        }

        /* Ayar Grupları */
        .settings-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .setting-label {
            font-size: 14px;
            font-weight: 500;
            color: #4facfe;
        }

        .bet-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .currency {
            position: absolute;
            left: 15px;
            color: #4facfe;
            font-weight: 600;
            z-index: 1;
        }

        .bet-input {
            width: 100%;
            padding: 12px 20px 12px 35px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .bet-input:focus {
            outline: none;
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.1);
        }

        .bet-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .bet-btn {
            flex: 1;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #b4b4b4;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bet-btn:hover {
            background: rgba(79, 172, 254, 0.1);
            border-color: #4facfe;
            color: #4facfe;
        }

        .mines-select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mines-select:focus {
            outline: none;
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.1);
        }

        .grid-size-buttons {
            display: flex;
            gap: 8px;
        }

        .grid-btn {
            flex: 1;
            padding: 10px 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #b4b4b4;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .grid-btn:hover {
            border-color: rgba(79, 172, 254, 0.5);
        }

        .grid-btn.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-color: transparent;
            color: white;
        }

        /* Play Button */
        .play-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #26de81 0%, #20bf6b 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
        }

        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(38, 222, 129, 0.3);
        }

        .play-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Game Info */
        .game-info {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
            text-align: center;
            flex: 1;
        }

        .info-label {
            font-size: 12px;
            color: #b4b4b4;
            font-weight: 500;
        }

        .info-value {
            font-size: 16px;
            color: #4facfe;
            font-weight: 700;
        }

        /* Sağ Panel - Oyun Alanı */
        .game-panel {
            flex: 1;
            max-width: 650px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        /* Oyun Header */
        .game-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .game-stats {
            display: flex;
            gap: 30px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #b4b4b4;
            font-weight: 500;
        }

        .stat-value {
            font-size: 18px;
            color: #ffffff;
            font-weight: 700;
        }

        .cashout-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .cashout-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 149, 0, 0.4);
        }

        .cashout-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        /* Mines Grid Container */
        .mines-grid-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Mines Grid */
        .mines-grid {
            display: grid;
            gap: 4px;
            max-width: 450px;
            width: 100%;
            padding: 25px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .grid-5x5 {
            grid-template-columns: repeat(5, 1fr);
        }

        .grid-6x6 {
            grid-template-columns: repeat(6, 1fr);
        }

        .grid-7x7 {
            grid-template-columns: repeat(7, 1fr);
        }

        .grid-8x8 {
            grid-template-columns: repeat(8, 1fr);
        }

        .grid-tile {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            position: relative;
            overflow: hidden;
            min-height: 70px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .grid-tile:hover:not(.revealed):not(.disabled) {
            background: rgba(79, 172, 254, 0.2);
            border-color: #4facfe;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(79, 172, 254, 0.3);
        }

        .grid-tile.revealed {
            cursor: default;
            transform: scale(0.95);
        }

        .grid-tile.gem {
            background: linear-gradient(135deg, #26de81 0%, #20bf6b 100%);
            border-color: #26de81;
            color: white;
            animation: gemReveal 0.5s ease-out;
            box-shadow: 0 0 20px rgba(38, 222, 129, 0.5);
        }

        .grid-tile.mine {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border-color: #ff6b6b;
            color: white;
            animation: mineExplode 0.5s ease-out;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
        }

        .grid-tile.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        @keyframes gemReveal {
            0% {
                transform: scale(0.8) rotate(-10deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.1) rotate(5deg);
            }
            100% {
                transform: scale(0.95) rotate(0deg);
                opacity: 1;
            }
        }

        @keyframes mineExplode {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            30% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(0.95);
                opacity: 1;
            }
        }

        /* Oyun Geçmişi */
        .game-history {
            margin-top: 30px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
        }

        .history-title {
            color: #4facfe;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .history-container {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-record {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-record.win {
            border-left: 4px solid #26de81;
        }

        .history-record.loss {
            border-left: 4px solid #ff6b6b;
        }

        .record-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .record-bet {
            font-size: 14px;
            color: #b4b4b4;
        }

        .record-result {
            font-size: 12px;
            color: #888;
        }

        .record-payout {
            font-size: 16px;
            font-weight: 700;
        }

        .record-payout.profit {
            color: #26de81;
        }

        .record-payout.loss {
            color: #ff6b6b;
        }

        .no-history {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .mines-container {
                flex-direction: column;
                padding: 15px;
                gap: 20px;
                overflow-y: auto;
                height: auto;
                min-height: 100vh;
            }

            .controls-panel {
                width: 100%;
                max-width: 500px;
                order: 2;
            }

            .game-panel {
                width: 100%;
                max-width: 600px;
                order: 1;
            }

            .mines-grid {
                max-width: 350px;
            }
        }

        @media (max-width: 768px) {
            .game-panel-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .game-stats {
                justify-content: space-around;
                gap: 20px;
            }

            .mines-grid {
                max-width: 320px;
                padding: 15px;
            }

            .grid-tile {
                min-height: 40px;
                font-size: 16px;
            }
        }
        
        /* Deposit Button */
        .deposit-button {
            padding: 12px 25px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 20px rgba(79, 172, 254, 0.3);
        }
        
        .withdraw-button {
            padding: 12px 25px;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 20px rgba(255, 107, 53, 0.3);
        }
        
        .deposit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(79, 172, 254, 0.5);
        }
        
        .withdraw-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(255, 107, 53, 0.5);
        }
        
        .logout-button {
            padding: 12px 25px;
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 20px rgba(108, 117, 125, 0.3);
        }
        
        .logout-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(108, 117, 125, 0.5);
        }
        
        .deposit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .deposit-content {
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
        }
        
        .deposit-title {
            font-size: 24px;
            font-weight: 700;
            color: #4facfe;
            margin-bottom: 20px;
        }
        
        .deposit-instruction {
            font-size: 18px;
            color: #ffffff;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(79, 172, 254, 0.3);
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            letter-spacing: 1px;
        }
        
        .close-modal {
            padding: 12px 30px;
            background: linear-gradient(135deg, #26de81 0%, #20bf6b 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .close-modal:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(38, 222, 129, 0.4);
        }
        
        /* Notification System */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 400px;
            padding: 15px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            z-index: 10001;
            opacity: 0;
            transform: translateX(-50%) translateY(-50px);
            transition: all 0.3s ease;
            border-left: 4px solid;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, rgba(38, 222, 129, 0.9) 0%, rgba(32, 191, 107, 0.9) 100%);
            border-left-color: #26de81;
        }
        
        .notification.error {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.9) 0%, rgba(238, 90, 36, 0.9) 100%);
            border-left-color: #ff6b6b;
        }
        
        .notification.info {
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.9) 0%, rgba(0, 242, 254, 0.9) 100%);
            border-left-color: #4facfe;
        }
    </style>
</head>
<body>
    <div class="background">
        <div class="snow" id="snow"></div>
    </div>
    
    <!-- Navigation & Action Buttons -->
    <div style="position: fixed; top: 20px; left: 20px; z-index: 9999;">
        <button onclick="window.location.href='./dashboard.html'" style="padding: 12px 25px; background: linear-gradient(135deg, #6c757d 0%, #495057 100%); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 700; cursor: pointer; text-transform: uppercase; box-shadow: 0 5px 20px rgba(108, 117, 125, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 30px rgba(108, 117, 125, 0.5)';" onmouseout="this.style.transform='';this.style.boxShadow='0 5px 20px rgba(108, 117, 125, 0.3)';">← Dashboard</button>
    </div>
    
    <!-- Deposit & Withdraw & Logout Buttons -->
    <div style="position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; gap: 10px;">
        <button class="deposit-button" id="depositBtn">Deposit</button>
        <button class="withdraw-button" id="withdrawBtn">Withdraw</button>
        <button class="logout-button" onclick="logoutMines()">Logout</button>
    </div>
    
    <!-- Deposit Modal -->
    <div class="deposit-modal" id="depositModal">
        <div class="deposit-content">
            <h2 class="deposit-title">Deposit Instructions</h2>
            <div class="deposit-instruction" id="depositInstruction">
                /pay eelhoed_pungent0
            </div>
            <p style="color: #b4b4b4; margin-bottom: 20px; font-size: 14px;">
                Send money using the command above. Your balance will be updated automatically.
            </p>
            <button class="close-modal" id="closeModal">Close</button>
        </div>
    </div>
    
    <!-- Withdraw Modal -->
    <div class="deposit-modal" id="withdrawModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; align-items: center; justify-content: center; z-index: 10000;">
        <div class="deposit-content" style="background: rgba(26, 26, 46, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 20px; padding: 40px; text-align: center; max-width: 400px; width: 90%; box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);">
            <h2 style="font-size: 24px; font-weight: 700; color: #ff6b35; margin-bottom: 20px;">Withdraw Funds</h2>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #b4b4b4; font-size: 14px; margin-bottom: 10px;">Current Balance: $<span id="withdrawBalance">0.00</span></label>
                <input type="number" id="withdrawAmount" placeholder="Enter amount" min="0" step="0.01" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 10px; color: white; font-size: 16px; text-align: center;" />
            </div>
            
            <p style="color: #b4b4b4; margin-bottom: 20px; font-size: 14px;">
                Enter the amount you want to withdraw. Funds will be sent to your Minecraft account.
            </p>
            
            <div style="display: flex; gap: 10px;">
                <button id="confirmWithdraw" style="flex: 1; padding: 12px 20px; background: linear-gradient(135deg, #26de81 0%, #20bf6b 100%); border: none; border-radius: 10px; color: white; font-size: 16px; font-weight: 600; cursor: pointer;">Withdraw</button>
                <button id="closeWithdrawModal" style="flex: 1; padding: 12px 20px; background: linear-gradient(135deg, #6c757d 0%, #495057 100%); border: none; border-radius: 10px; color: white; font-size: 16px; font-weight: 600; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>
    

    <div class="mines-container">
        <!-- Sol Panel - Kontroller -->
        <div class="controls-panel">
            <div class="game-header">
                <div class="logo">
                    <div class="logo-icon"></div>
                    <h1 class="game-title">Mines</h1>
                </div>
            </div>

            <div class="balance-display">
                <div class="balance-label">Balance</div>
                <div class="balance-amount">$<span id="userBalance">0.00</span></div>
            </div>
            
            <!-- Welcome mesajı ekle -->
            <div style="text-align: center; color: #b4b4b4; font-size: 14px; margin-bottom: 15px;">
                <span id="welcomeUser">Welcome, Player!</span>
            </div>

            <div class="control-tabs">
                <button class="tab-btn active" data-tab="manual">Manual</button>
            </div>

            <div class="settings-section">
                <div class="setting-group">
                    <label class="setting-label">Bet Amount</label>
                    <div class="bet-input-container">
                        <span class="currency">$</span>
                        <input type="number" class="bet-input" id="betAmount" value="1.00" min="0" step="0.01">
                    </div>
                    <div class="bet-buttons">
                        <button class="bet-btn" data-multiplier="0.5">½</button>
                        <button class="bet-btn" data-multiplier="2">2x</button>
                    </div>
                </div>

                <div class="setting-group">
                    <label class="setting-label">Mines</label>
                    <select class="mines-select" id="mineCount">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3" selected>3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                        <option value="24">24</option>
                    </select>
                </div>

            </div>

            <button class="play-btn" id="playMines">PLAY</button>
            
            <button class="cashout-btn" id="cashoutBtn" disabled style="width: 100%; margin-bottom: 20px;">Cashout $0.00</button>

            <div class="game-info">
                <div class="info-item">
                    <span class="info-label">Next Multiplier</span>
                    <span class="info-value" id="nextMultiplier">1.93x</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Payout on cashout</span>
                    <span class="info-value">$<span id="payoutAmount">0.00</span></span>
                </div>
            </div>
        </div>

        <!-- Sağ Panel - Oyun Stats -->
        <div class="game-panel">
            <div class="game-panel-header">
                <div class="game-stats">
                    <div class="stat">
                        <span class="stat-label">Gems Found:</span>
                        <span class="stat-value" id="gemsFound">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Current Multiplier:</span>
                        <span class="stat-value" id="currentMultiplier">0.00x</span>
                    </div>
                </div>
            </div>
            
            <!-- Mines Grid Container -->
            <div class="mines-grid-container">
                <div class="mines-grid grid-5x5" id="minesGrid">
                    <!-- Grid tiles will be generated by JavaScript -->
                </div>
            </div>

            <div class="game-history">
                <h4 class="history-title">Recent Games</h4>
                <div class="history-container" id="gameHistory">
                    <p class="no-history">No games played yet</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mines oyun durumu
        let minesGame = {
            active: false,
            gameId: null,
            gridSize: 25,
            mineCount: 3,
            betAmount: 0,
            currentMultiplier: 0,
            gemsFound: 0,
            minePositions: [],
            revealedTiles: [],
            userBalance: 0.00
        };

        // Login kontrolü
        function checkLogin() {
            // URL parametresinden username kontrol et
            const urlParams = new URLSearchParams(window.location.search);
            const urlUsername = urlParams.get('user');
            if (urlUsername) {
                console.log('🔗 Mines - URL\'den username:', urlUsername);
                balanceManager.saveUsername(urlUsername);
                return true;
            }
            
            const username = balanceManager.getUsername();
            if (!username || username === 'international374') {
                console.log('❌ Mines username yok - login formı göster');
                showLoginForm();
                return false;
            }
            console.log('✅ Mines login başarılı:', username);
            return true;
        }
        
        // Güzel login formu göster
        function showLoginForm() {
            // Ana container'ı gizle
            document.querySelector('.mines-container').style.display = 'none';
            
            // Login formu oluştur
            const loginOverlay = document.createElement('div');
            loginOverlay.id = 'loginOverlay';
            loginOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                backdrop-filter: blur(10px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            loginOverlay.innerHTML = `
                <div style="
                    background: rgba(255, 255, 255, 0.08);
                    backdrop-filter: blur(20px);
                    border: 1px solid rgba(255, 255, 255, 0.12);
                    border-radius: 25px;
                    padding: 50px 40px;
                    text-align: center;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
                ">
                    <div style="
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 15px;
                        margin-bottom: 30px;
                    ">
                        <div style="
                            width: 60px;
                            height: 60px;
                            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: 900;
                            font-size: 28px;
                            box-shadow: 0 10px 30px rgba(79, 172, 254, 0.3);
                        ">M</div>
                        <div style="
                            font-size: 32px;
                            font-weight: 700;
                            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                            -webkit-background-clip: text;
                            -webkit-text-fill-color: transparent;
                        ">Mines</div>
                    </div>
                    
                    <h2 style="
                        font-size: 24px;
                        font-weight: 600;
                        color: #ffffff;
                        margin-bottom: 10px;
                    ">Welcome to Mines!</h2>
                    
                    <p style="
                        font-size: 16px;
                        color: #b4b4b4;
                        margin-bottom: 40px;
                        line-height: 1.6;
                    ">Enter your Minecraft username to start playing</p>
                    
                    <div style="text-align: left; margin-bottom: 20px;">
                        <label style="
                            display: block;
                            color: #4facfe;
                            font-size: 14px;
                            font-weight: 600;
                            margin-bottom: 8px;
                        ">Minecraft Username</label>
                        <input type="text" id="minesUsername" placeholder="Enter your username..." style="
                            width: 100%;
                            padding: 15px 20px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 2px solid rgba(255, 255, 255, 0.1);
                            border-radius: 15px;
                            color: #ffffff;
                            font-size: 16px;
                            font-weight: 500;
                            transition: all 0.3s ease;
                            outline: none;
                            box-sizing: border-box;
                        " />
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button id="minesLoginBtn" style="
                            flex: 1;
                            background: linear-gradient(135deg, #26de81 0%, #20bf6b 100%);
                            border: none;
                            padding: 18px 25px;
                            border-radius: 15px;
                            color: white;
                            font-size: 16px;
                            font-weight: 700;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                            box-shadow: 0 10px 30px rgba(38, 222, 129, 0.3);
                        ">Enter Game</button>
                        
                        <button id="minesCancelBtn" style="
                            background: rgba(255, 255, 255, 0.1);
                            border: 1px solid rgba(255, 255, 255, 0.3);
                            padding: 18px 25px;
                            border-radius: 15px;
                            color: white;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        ">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(loginOverlay);
            
            // Event listener'lar
            const usernameInput = document.getElementById('minesUsername');
            const loginBtn = document.getElementById('minesLoginBtn');
            const cancelBtn = document.getElementById('minesCancelBtn');
            
            // Input stil güncellemeleri
            usernameInput.addEventListener('focus', function() {
                this.style.borderColor = '#4facfe';
                this.style.background = 'rgba(79, 172, 254, 0.1)';
                this.style.boxShadow = '0 0 20px rgba(79, 172, 254, 0.2)';
            });
            
            usernameInput.addEventListener('blur', function() {
                this.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                this.style.background = 'rgba(255, 255, 255, 0.05)';
                this.style.boxShadow = 'none';
            });
            
            // Buton hover efektleri
            loginBtn.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-3px)';
                this.style.boxShadow = '0 15px 40px rgba(38, 222, 129, 0.5)';
            });
            
            loginBtn.addEventListener('mouseleave', function() {
                this.style.transform = 'none';
                this.style.boxShadow = '0 10px 30px rgba(38, 222, 129, 0.3)';
            });
            
            cancelBtn.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-2px)';
                this.style.background = 'rgba(255, 255, 255, 0.2)';
            });
            
            cancelBtn.addEventListener('mouseleave', function() {
                this.style.transform = 'none';
                this.style.background = 'rgba(255, 255, 255, 0.1)';
            });
            
            // Enter tuşu ile login
            usernameInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    handleMinesLogin();
                }
            });
            
            // Login butonu
            loginBtn.addEventListener('click', handleMinesLogin);
            
            // Cancel butonu
            cancelBtn.addEventListener('click', function() {
                window.location.href = './dashboard.html';
            });
            
            // Input'a focus
            setTimeout(() => {
                usernameInput.focus();
            }, 100);
        }
        
        // Mines login işlemi
        function handleMinesLogin() {
            const username = document.getElementById('minesUsername').value.trim();
            
            if (!username) {
                showMinesNotification('Please enter your username!', 'error');
                return;
            }
            
            if (username.length < 3 || username.length > 16) {
                showMinesNotification('Username must be between 3-16 characters!', 'error');
                return;
            }
            
            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                showMinesNotification('Username can only contain letters, numbers, and underscores!', 'error');
                return;
            }
            
            // Username'ı kaydet
            balanceManager.saveUsername(username);
            console.log('✅ Mines login başarılı:', username);
            
            // Login overlay'i kaldır
            const overlay = document.getElementById('loginOverlay');
            if (overlay) {
                overlay.remove();
            }
            
            // Ana container'ı göster
            document.querySelector('.mines-container').style.display = 'flex';
            
            // Oyunu başlat
            initializeMines();
            setupDepositListeners();
            
            showMinesNotification(`Welcome to Mines, ${username}!`, 'success');
        }
        
        // Mines notification sistemi
        function showMinesNotification(message, type = 'info', duration = 4000) {
            // Mevcut notification'ları kaldır
            const existingNotifications = document.querySelectorAll('.mines-notification');
            existingNotifications.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `mines-notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                max-width: 400px;
                padding: 15px 20px;
                border-radius: 12px;
                color: white;
                font-weight: 600;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(10px);
                z-index: 10001;
                opacity: 0;
                transition: all 0.3s ease;
                border-left: 4px solid;
            `;
            
            // Tip'e göre renk
            if (type === 'success') {
                notification.style.background = 'linear-gradient(135deg, rgba(38, 222, 129, 0.9) 0%, rgba(32, 191, 107, 0.9) 100%)';
                notification.style.borderLeftColor = '#26de81';
            } else if (type === 'error') {
                notification.style.background = 'linear-gradient(135deg, rgba(255, 107, 107, 0.9) 0%, rgba(238, 90, 36, 0.9) 100%)';
                notification.style.borderLeftColor = '#ff6b6b';
            } else {
                notification.style.background = 'linear-gradient(135deg, rgba(79, 172, 254, 0.9) 0%, rgba(0, 242, 254, 0.9) 100%)';
                notification.style.borderLeftColor = '#4facfe';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animasyon
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(-50%) translateY(0)';
            }, 100);
            
            // Otomatik kaldırma
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(-50%) translateY(-50px)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }
        
        // Para formatını parse et (k/m multiplier desteği)
        function parseAmount(input) {
            if (!input) return 0;
            
            let str = input.toString().toLowerCase().trim();
            console.log('🔍 Para parse ediliyor:', input, '->');
            
            // Nokta ve diğer gereksiz karakterleri temizle
            str = str.replace(/[^0-9.km]/g, ''); // Sadece sayı, nokta, k, m kalsın
            console.log('Temizlendi:', str);
            
            // k/m multiplier kontrol et
            const kMatch = str.match(/^([0-9]*\.?[0-9]+)k$/);
            const mMatch = str.match(/^([0-9]*\.?[0-9]+)m$/);
            
            if (kMatch) {
                const number = parseFloat(kMatch[1]);
                const result = number * 1000;
                console.log('K multiplier:', number, '*', 1000, '=', result);
                return result;
            }
            
            if (mMatch) {
                const number = parseFloat(mMatch[1]);
                const result = number * 1000000;
                console.log('M multiplier:', number, '*', 1000000, '=', result);
                return result;
            }
            
            // Sadece sayı varsa
            const result = parseFloat(str) || 0;
            console.log('Normal sayı:', str, '->', result);
            return result;
        }
        
        // Logout fonksiyonu (Mines)
        function logoutMines() {
            if (confirm('Are you sure you want to logout?')) {
                showNotification('Logging out...', 'info', 2000);
                
                // Balance'ı server'a kaydet
                balanceManager.syncWithServer();
                
                // Sadece gerekli verileri temizle (balance'ı değil!)
                localStorage.removeItem('donutflip_username');
                localStorage.removeItem('donutflip_tpa_verified');
                localStorage.removeItem('donutflip_verify_time');
                // donutflip_balance KALSIN - server'dan yüklenecek
                
                console.log('🚪 Mines Logout - Session temizlendi, balance korundu');
                
                setTimeout(() => {
                    window.location.href = './index.html';
                }, 1000);
            }
        }
        
        // Sayfa yüklendiikten sonra başlat
        document.addEventListener('DOMContentLoaded', function() {
            // Önce login kontrolü yap
            if (!checkLogin()) {
                return; // Login sayfasına yönlendirildiyse burada dur
            }
            
            // Balance Manager ile entegrasyon - sadece callback
            balanceManager.onBalanceChange(function(balance, username) {
                minesGame.userBalance = balance;
                updateUserBalance();
                updateWelcomeMessage(username);
            });
            
            // Başlangıçta balance'ı sync et
            minesGame.userBalance = balanceManager.getBalance();
            
            // Server'dan bakiye yükle - geciktirilmiş
            setTimeout(() => {
                balanceManager.loadFromServer();
            }, 1000);
            
            initializeMines();
            setupDepositListeners();
        });

        // Mines oyununu başlat
        function initializeMines() {
            setupMinesEventListeners();
            createMinesGrid();
            // Balance Manager zaten yüklenmiş olacak
            updateUserBalance(); // UI'ı başlangıçta güncelle
            updateWelcomeMessage(balanceManager.getUsername());
            updateMinesInfo();
            setupWebSocket(); // WebSocket bağlantısını kur
            
            console.log('💎 Mines oyunu hazır!');
            console.log('💰 Current balance:', balanceManager.getBalance());
            console.log('👥 Current username:', balanceManager.getUsername());
        }

        // Event listener'ları kur
        function setupMinesEventListeners() {
            // Tab butonları
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Bet amount butonları
            document.querySelectorAll('.bet-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const multiplier = parseFloat(this.dataset.multiplier);
                    let currentBet = parseFloat(document.getElementById('betAmount').value) || 0;
                    if (currentBet <= 0) currentBet = 1; // Minimum bet 1
                    const newBet = currentBet * multiplier;
                    const finalBet = Math.min(newBet, balanceManager.getBalance());
                    document.getElementById('betAmount').value = finalBet.toFixed(2);
                    updateMinesInfo();
                });
            });
            
            // Grid size sabit 25 (5x5)
            
            // Mine count değişimi
            document.getElementById('mineCount').addEventListener('change', function() {
                minesGame.mineCount = parseInt(this.value);
                updateMinesInfo();
            });
            
            // Bet amount değişimi - sadece blur olduğunda kontrol et
            document.getElementById('betAmount').addEventListener('blur', function() {
                let amount = parseAmount(this.value); // Yeni parse fonksiyonu
                amount = Math.min(amount, balanceManager.getBalance());
                amount = Math.max(amount, 0); // Negatif olmasın
                this.value = amount.toFixed(2);
                updateMinesInfo();
                
                console.log('💰 Bet amount parsed:', this.value, '->', amount);
            });
            
            // Input sırasında sadece multiplier info güncelle
            document.getElementById('betAmount').addEventListener('input', function() {
                updateMinesInfo();
            });
            
            // Play butonu
            document.getElementById('playMines').addEventListener('click', startMinesGame);
            
            // Cashout butonu
            document.getElementById('cashoutBtn').addEventListener('click', cashoutMines);
        }
        // Deposit & Withdraw event listener'larını kur
        function setupDepositListeners() {
            const depositBtn = document.getElementById('depositBtn');
            const depositModal = document.getElementById('depositModal');
            const closeModal = document.getElementById('closeModal');
            
            const withdrawBtn = document.getElementById('withdrawBtn');
            const withdrawModal = document.getElementById('withdrawModal');
            const closeWithdrawModal = document.getElementById('closeWithdrawModal');
            const confirmWithdraw = document.getElementById('confirmWithdraw');
            
            // Bot adını al ve güncelle
            updateBotName();
            
            // Deposit butonuna tıklama
            depositBtn.addEventListener('click', function() {
                updateBotName(); // Her açışta bot adını güncelle
                depositModal.style.display = 'flex';
            });
            
            // Withdraw butonuna tıklama
            withdrawBtn.addEventListener('click', function() {
                document.getElementById('withdrawBalance').textContent = balanceManager.getBalance().toFixed(2);
                document.getElementById('withdrawAmount').value = '';
                withdrawModal.style.display = 'flex';
            });
            
            // Withdraw onaylama
            confirmWithdraw.addEventListener('click', async function() {
                const amount = parseFloat(document.getElementById('withdrawAmount').value) || 0;
                
                if (amount <= 0) {
                    showNotification('Please enter a valid amount!', 'error');
                    return;
                }
                
                const result = await balanceManager.processWithdraw(amount);
                
                if (result.success) {
                    showNotification(result.message, 'success');
                } else {
                    showNotification('Withdrawal failed: ' + result.error, 'error');
                }
                
                withdrawModal.style.display = 'none';
            });
            
            // Modal'ı kapatma
            closeModal.addEventListener('click', function() {
                depositModal.style.display = 'none';
            });
            
            closeWithdrawModal.addEventListener('click', function() {
                withdrawModal.style.display = 'none';
            });
            
            // Modal dışına tıklayınca kapatma
            depositModal.addEventListener('click', function(e) {
                if (e.target === depositModal) {
                    depositModal.style.display = 'none';
                }
            });
            
            withdrawModal.addEventListener('click', function(e) {
                if (e.target === withdrawModal) {
                    withdrawModal.style.display = 'none';
                }
            });
            
            // ESC tuşu ile kapatma
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (depositModal.style.display === 'flex') {
                        depositModal.style.display = 'none';
                    }
                    if (withdrawModal.style.display === 'flex') {
                        withdrawModal.style.display = 'none';
                    }
                }
            });
        }
        
        // Deposit fonksiyonu (bot entegrasyonu için) - Balance Manager ile
        function addDeposit(amount) {
            return balanceManager.addBalance(amount);
        }
        
        // Bot adını güncelle
        async function updateBotName() {
            const depositInfo = await balanceManager.processDeposit();
            document.getElementById('depositInstruction').textContent = depositInfo.command;
        }
        
        // Bakiyeyi bot ile senkronize et - Balance Manager otomatik yapar
        function syncBalanceWithBot() {
            // Balance Manager otomatik olarak server ile sync yapar
            console.log('🔄 Balance sync handled by BalanceManager');
        }
        
        // Global deposit fonksiyonu (dışarıdan erişim için)
        window.addDeposit = addDeposit;
        
        // Notification sistemi
        function showNotification(message, type = 'info', duration = 4000) {
            // Eski notification'ları kaldır
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Animation için küçük gecikme
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Otomatik kaldırma
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }

        // Grid oluştur (sabit 5x5)
        function createMinesGrid() {
            const grid = document.getElementById('minesGrid');
            
            // Grid sınıfını sabit 5x5 yap
            grid.className = 'mines-grid grid-5x5';
            grid.innerHTML = '';
            
            // 25 tile oluştur (5x5)
            for (let i = 0; i < 25; i++) {
                const tile = document.createElement('div');
                tile.className = 'grid-tile';
                tile.dataset.index = i;
                tile.addEventListener('click', () => revealTile(i));
                grid.appendChild(tile);
            }
            
            // Grid size'ı 25'e sabitler
            minesGame.gridSize = 25;
        }
        
        // Grid'i sadece görsel olarak sıfırla (mayınları gizle)
        function resetMinesGridVisually() {
            document.querySelectorAll('.grid-tile').forEach(tile => {
                tile.classList.remove('revealed', 'mine', 'gem', 'disabled');
                tile.textContent = '';
                tile.style.pointerEvents = 'auto';
            });
        }

        // Oyunu başlat
        function startMinesGame() {
            const betAmount = parseAmount(document.getElementById('betAmount').value);
            
            console.log('🎲 Starting game with bet:', document.getElementById('betAmount').value, '->', betAmount);
            
            if (betAmount <= 0) {
                showNotification('Please enter a valid bet amount!', 'error');
                return;
            }
            
            if (!balanceManager.hasBalance(betAmount)) {
                showNotification('Insufficient balance!', 'error');
                return;
            }
            
            if (minesGame.active) {
                showNotification('A game is already in progress!', 'error');
                return;
            }
            
            // Oyunu başlat - önce grid'i temizle
            resetMinesGridVisually();
            
            minesGame.active = true;
            minesGame.gameId = Date.now().toString();
            minesGame.betAmount = betAmount;
            minesGame.currentMultiplier = 0;
            minesGame.gemsFound = 0;
            minesGame.revealedTiles = [];
            
            // Bahis miktarını Balance Manager ile çek
            balanceManager.subtractBalance(betAmount);
            minesGame.userBalance = balanceManager.getBalance();
            
            // Mayınları yerleştir
            placeMines();
            
            // UI'ı güncelle
            updateMinesUI();
            updateUserBalance();
            
            // Bahis yapıldıkça bakiyeyi senkronize et
            syncBalanceWithBot();
            
            console.log(`🎮 Oyun başladı! Bahis: $${betAmount.toFixed(2)}`);
        }

        // Mayınları yerleştir
        function placeMines() {
            minesGame.minePositions = [];
            const positions = new Set();
            
            while (positions.size < minesGame.mineCount) {
                const pos = Math.floor(Math.random() * minesGame.gridSize);
                positions.add(pos);
            }
            
            minesGame.minePositions = Array.from(positions);
            console.log('💣 Mayınlar yerleştirildi:', minesGame.minePositions);
        }

        // Tile aç
        function revealTile(index) {
            if (!minesGame.active) {
                showNotification('Start the game first!', 'info');
                return;
            }
            
            if (minesGame.revealedTiles.includes(index)) {
                return; // Zaten açılmış
            }
            
            const tile = document.querySelector(`[data-index="${index}"]`);
            minesGame.revealedTiles.push(index);
            tile.classList.add('revealed');
            
            if (minesGame.minePositions.includes(index)) {
                // Mayına bastı!
                tile.classList.add('mine');
                tile.textContent = 'MINE';
                
                // Tüm mayınları göster
                minesGame.minePositions.forEach(mineIndex => {
                    const mineTile = document.querySelector(`[data-index="${mineIndex}"]`);
                    mineTile.classList.add('mine', 'revealed');
                    mineTile.textContent = 'MINE';
                });
                
                // Oyunu bitir
                endGame(false);
                
            } else {
                // Gem buldu!
                tile.classList.add('gem');
                tile.textContent = 'GEM';
                minesGame.gemsFound++;
                
                // Çarpanı hesapla
                calculateMultiplier();
                updateMinesUI();
                
                // Kazanma kontrolü
                const totalSafeTiles = minesGame.gridSize - minesGame.mineCount;
                if (minesGame.gemsFound >= totalSafeTiles) {
                    endGame(true);
                }
            }
        }

        // Çarpan hesapla
        function calculateMultiplier() {
            const safeTiles = minesGame.gridSize - minesGame.mineCount;
            const remaining = safeTiles - minesGame.gemsFound;
            
            if (remaining <= 0) {
                minesGame.currentMultiplier = 0;
                return;
            }
            
            // Basit çarpan formülü
            let multiplier = 1;
            for (let i = 0; i < minesGame.gemsFound; i++) {
                const safeLeft = safeTiles - i;
                const totalLeft = minesGame.gridSize - minesGame.revealedTiles.length + i + 1;
                multiplier *= (totalLeft / safeLeft);
            }
            
            minesGame.currentMultiplier = multiplier;
            
            // Next multiplier hesapla
            let nextMultiplier = multiplier;
            const nextSafeLeft = safeTiles - minesGame.gemsFound;
            const nextTotalLeft = minesGame.gridSize - minesGame.revealedTiles.length;
            if (nextTotalLeft > 0 && nextSafeLeft > 0) {
                nextMultiplier *= (nextTotalLeft / nextSafeLeft);
            }
            
            // UI'ı güncelle
            document.getElementById('nextMultiplier').textContent = nextMultiplier.toFixed(2) + 'x';
        }

        // Para çek
        function cashoutMines() {
            if (!minesGame.active || minesGame.gemsFound === 0) {
                return;
            }
            
            const winAmount = minesGame.betAmount * minesGame.currentMultiplier;
            
            // Kazanç miktarını Balance Manager ile ekle
            balanceManager.addBalance(winAmount);
            minesGame.userBalance = balanceManager.getBalance();
            
            // Oyun geçmişine ekle
            addGameToHistory({
                bet: minesGame.betAmount,
                win: winAmount,
                multiplier: minesGame.currentMultiplier,
                gems: minesGame.gemsFound,
                result: 'cashout'
            });
            
            endGame(true);
            syncBalanceWithBot(); // Bakiyeyi bot ile senkronize et
            showNotification(`Success! You won $${winAmount.toFixed(2)}!`, 'success');
        }

        // Oyunu bitir
        function endGame(won) {
            minesGame.active = false;
            
            // Tüm tile'ları devre dışı bırak ama mayınları görünür bırak
            document.querySelectorAll('.grid-tile').forEach(tile => {
                tile.classList.add('disabled');
            });
            
            // UI'ı güncelle
            updateMinesUI();
            updateUserBalance();
            
            if (!won) {
                // Oyun geçmişine ekle
                addGameToHistory({
                    bet: minesGame.betAmount,
                    win: 0,
                    multiplier: 0,
                    gems: minesGame.gemsFound,
                    result: 'mine'
                });
                
                syncBalanceWithBot(); // Bakiyeyi bot ile senkronize et
                showNotification(`Game over! You lost $${minesGame.betAmount.toFixed(2)}.`, 'error');
            }
            
            // Grid'i sıfırlama yok - mayınlar görünür kalacak
            // Yeni oyun başlatıldığında sıfırlanacak
        }

        // Oyunu sıfırla
        function resetMinesGame() {
            minesGame.active = false;
            minesGame.gameId = null;
            minesGame.currentMultiplier = 0;
            minesGame.gemsFound = 0;
            minesGame.revealedTiles = [];
            minesGame.minePositions = [];
            
            createMinesGrid();
            updateMinesUI();
            updateMinesInfo();
        }

        // UI güncelle
        function updateMinesUI() {
            // Game stats
            document.getElementById('gemsFound').textContent = minesGame.gemsFound;
            document.getElementById('currentMultiplier').textContent = minesGame.currentMultiplier.toFixed(2) + 'x';
            
            // Play button
            const playBtn = document.getElementById('playMines');
            if (minesGame.active) {
                playBtn.textContent = 'Game in Progress';
                playBtn.disabled = true;
            } else {
                playBtn.textContent = 'PLAY';
                playBtn.disabled = false;
            }
            
            // Cashout button
            const cashoutBtn = document.getElementById('cashoutBtn');
            if (minesGame.active && minesGame.gemsFound > 0) {
                const winAmount = minesGame.betAmount * minesGame.currentMultiplier;
                cashoutBtn.textContent = `Cashout $${winAmount.toFixed(2)}`;
                cashoutBtn.disabled = false;
            } else {
                cashoutBtn.textContent = 'Cashout $0.00';
                cashoutBtn.disabled = true;
            }
        }

        // Mines info güncelle
        function updateMinesInfo() {
            const betAmount = parseFloat(document.getElementById('betAmount').value) || 0;
            const safeTiles = minesGame.gridSize - minesGame.mineCount;
            
            // İlk click için multiplier hesapla
            let firstClickMultiplier = minesGame.gridSize / safeTiles;
            
            document.getElementById('nextMultiplier').textContent = firstClickMultiplier.toFixed(2) + 'x';
            document.getElementById('payoutAmount').textContent = (betAmount * firstClickMultiplier).toFixed(2);
        }

        // Bakiye güncelle
        function updateUserBalance() {
            document.getElementById('userBalance').textContent = balanceManager.getBalance().toFixed(2);
            const withdrawEl = document.getElementById('withdrawBalance');
            if (withdrawEl) withdrawEl.textContent = balanceManager.getBalance().toFixed(2);
            minesGame.userBalance = balanceManager.getBalance();
        }

        // Oyun geçmişine ekle
        function addGameToHistory(game) {
            const historyContainer = document.getElementById('gameHistory');
            
            // "No games" mesajını kaldır
            const noHistory = historyContainer.querySelector('.no-history');
            if (noHistory) {
                noHistory.remove();
            }
            
            const record = document.createElement('div');
            record.className = `history-record ${game.win > game.bet ? 'win' : 'loss'}`;
            
            const info = document.createElement('div');
            info.className = 'record-info';
            info.innerHTML = `
                <div class="record-bet">Bet: $${game.bet.toFixed(2)} | ${game.gems} gems</div>
                <div class="record-result">${game.result === 'mine' ? 'Hit mine' : game.result === 'cashout' ? 'Cashed out' : 'Max win'}</div>
            `;
            
            const payout = document.createElement('div');
            payout.className = `record-payout ${game.win > game.bet ? 'profit' : 'loss'}`;
            const profit = game.win - game.bet;
            payout.textContent = `${profit >= 0 ? '+' : ''}$${profit.toFixed(2)}`;
            
            record.appendChild(info);
            record.appendChild(payout);
            
            // En üste ekle
            historyContainer.insertBefore(record, historyContainer.firstChild);
            
            // Maksimum 10 kayıt tut
            while (historyContainer.children.length > 10) {
                historyContainer.removeChild(historyContainer.lastChild);
            }
        }

        // loadUserBalance fonksiyonu artık Balance Manager tarafından yönetiliyor
        
        // Welcome mesajını güncelle
        function updateWelcomeMessage(username) {
            const welcomeEl = document.getElementById('welcomeUser');
            if (welcomeEl) {
                welcomeEl.textContent = `Welcome, ${username}!`;
            }
        }
        
        // WebSocket bağlantısını kur
        function setupWebSocket() {
            // Socket.IO mevcut mu kontrol et
            if (typeof io === 'undefined') {
                console.log('⚠️ Socket.IO bulunamadı, WebSocket devre dışı');
                return;
            }
            
            try {
                const socket = io();
                
                socket.on('connect', function() {
                    console.log('🔗 WebSocket bağlandı');
                });
                
                socket.on('disconnect', function() {
                    console.log('🔌 WebSocket bağlantısı kesildi');
                });
                
                // Para geldiğinde bakiyeyi güncelle
                socket.on('moneyReceived', function(data) {
                    console.log('💰 Para geldi:', data);
                    
                    // BalanceManager ile bakiyeyi güncelle
                    balanceManager.setBalance(data.newBalance);
                    
                    // Bildirim göster
                    showNotification(`Money received! +$${data.amount.toFixed(2)} from ${data.from}`, 'success');
                });
                
                // Hata mesajları
                socket.on('error', function(data) {
                    console.log('❌ Hata:', data.message);
                });
            } catch (error) {
                console.log('⚠️ WebSocket bağlantı hatası:', error);
            }
        }
        
        // Snow animation initialization
        function createSnowflakes() {
            const snowContainer = document.getElementById('snow');
            const snowflakeCount = 100;
            
            for (let i = 0; i < snowflakeCount; i++) {
                const snowflake = document.createElement('div');
                snowflake.classList.add('snowflake');
                snowflake.textContent = '❄';
                
                // Random horizontal position
                snowflake.style.left = Math.random() * 100 + '%';
                
                // Random animation duration (3-8 seconds)
                snowflake.style.animationDuration = (Math.random() * 5 + 3) + 's';
                
                // Random delay
                snowflake.style.animationDelay = Math.random() * 2 + 's';
                
                // Random size
                const size = Math.random() * 8 + 8;
                snowflake.style.fontSize = size + 'px';
                
                snowContainer.appendChild(snowflake);
            }
        }
        
        // Initialize snow on page load
        document.addEventListener('DOMContentLoaded', function() {
            createSnowflakes();
        });

        // Debug: Global değişkenleri konsola logla
        window.debugMines = function() {
            console.log('🔍 Mines Debug Info:');
            console.log('Game State:', minesGame);
            console.log('Balance Manager Balance:', balanceManager.getBalance());
            console.log('Local Game Balance:', minesGame.userBalance);
            console.log('Mine Positions:', minesGame.minePositions);
            console.log('Revealed Tiles:', minesGame.revealedTiles);
        };
        
        // Debug: Bakiyeyi server'dan manuel yükle
        window.refreshBalance = async function() {
            console.log('🔄 Refreshing balance from server...');
            await balanceManager.loadFromServer();
            updateUserBalance();
            console.log('✅ Balance refreshed:', balanceManager.getBalance());
        };
        
        // Debug: Bakiyeyi manuel set et
        window.setBalance = function(amount) {
            balanceManager.setBalance(amount);
            console.log('✅ Balance set to:', amount);
        };
        
    </script>
</body>
</html>